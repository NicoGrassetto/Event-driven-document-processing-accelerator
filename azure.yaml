name: event-driven-document-processing
metadata:
  template: event-driven-document-processing@1.0.0

services:
  api:
    project: ./src
    language: python
    host: function

infra:
  provider: bicep
  path: ./infra

hooks:
  preprovision:
    posix:
      shell: sh
      run: |
        echo "Setting deploying user's principal ID for Cosmos DB access..."
        USER_PRINCIPAL_ID=$(az ad signed-in-user show --query id -o tsv 2>/dev/null)
        if [ -n "$USER_PRINCIPAL_ID" ]; then
          azd env set userPrincipalId "$USER_PRINCIPAL_ID"
          echo "✓ Set userPrincipalId: $USER_PRINCIPAL_ID"
        else
          echo "⚠ Could not get user principal ID - Cosmos DB Portal access won't be configured"
        fi
      continueOnError: true
    windows:
      shell: pwsh
      run: |
        Write-Host "Setting deploying user's principal ID for Cosmos DB access..."
        $userPrincipalId = az ad signed-in-user show --query id -o tsv 2>$null
        if ($userPrincipalId) {
          azd env set userPrincipalId $userPrincipalId
          Write-Host "✓ Set userPrincipalId: $userPrincipalId"
        } else {
          Write-Host "⚠ Could not get user principal ID - Cosmos DB Portal access won't be configured"
        }
      continueOnError: true

  postprovision:
    posix:
      shell: sh
      run: |
        echo "Creating Content Understanding analyzer..."
        chmod +x ./scripts/create-analyzer.sh
        ./scripts/create-analyzer.sh
      interactive: true
      continueOnError: false
    windows:
      shell: pwsh
      run: |
        Write-Host "Creating Content Understanding analyzer..."
        ./scripts/create-analyzer.ps1
      interactive: true
      continueOnError: false

  postdeploy:
    posix:
      shell: sh
      run: |
        echo "Creating Event Grid subscription..."
        chmod +x ./scripts/create-eventgrid-subscription.sh
        ./scripts/create-eventgrid-subscription.sh
      interactive: true
      continueOnError: false
